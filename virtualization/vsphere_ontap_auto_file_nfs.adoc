---
sidebar: sidebar 
permalink: virtualization/vsphere_ontap_auto_file_nfs.html 
keywords: vSphere, datastore, nfs, ONTAP tools, vlan, network interface, service policy, export policy 
summary: 本頁提供在ONTAP VMware vSphere環境中部署NetApp支援NFS版本3資料存放區的步驟。 
---
= vSphere NFS資料存放區-版本3含ONTAP
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./../media/
:scriptsdir: ./../scripts/
:author: Suresh Thoppay, TME - Hybrid Cloud Solutions
:ontap_version: ONTAP 9.8 or later
:vsphere_version: vSphere 7.0 or later
:includesdir: ./../
:firstname: Suresh
:authorinitials: STT
:middlename: Thoppay,
:lastname: TME - Hybrid Cloud Solutions
:authors: Suresh Thoppay, TME - Hybrid Cloud Solutions




== 關於這項工作

建立NFS版本3資料存放區、並搭配ONTAP 使用不實的NAS儲存設備。

如需自動化資源配置、請使用下列其中一個指令碼： <<PowerShell>>、 <<Ansible>>或 <<Terraform>>。



== 您需要的一切

* 管理vSphere環境與ONTAP 功能的基本技能。
* 執行《支援資料》的不支援資料系統（FAS/AFF/CVO/ONTAP Select/Cloud Volume Service/Azure NetApp Files）ONTAP ONTAP
* 資訊（SVM名稱、使用者ID、密碼）ONTAP
* NFS的網路連接埠、SVM和LUN資訊ONTAP
+
** link:++https://docs.netapp.com/ontap-9/topic/com.netapp.doc.exp-nfs-vaai/GUID-BBD301EF-496A-4974-B205-5F878E44BF59.html++["完整的NFS組態工作表"]


* vCenter Server認證
* vSphere 7.0或更新版本的vSphere主機資訊
* NFS VMKernel介面卡IP資訊
* 網路交換器
+
** 搭配ONTAP 使用NetApp系統網路資料連接埠和連線的vSphere主機
** 為NFS設定的VLAN
** （選用）連結集合、設定ONTAP 用於連接至整套網路資料連接埠


* VMware vSphere適用的VMware vSphere工具已部署、已設定且隨時可供使用ONTAP




== 步驟

* 檢查與的相容性 https://mysupport.netapp.com/matrix["互通性對照表工具IMT （不含）"]
+
** link:++https://docs.netapp.com/ontap-9/topic/com.netapp.doc.exp-nfs-vaai/GUID-DA231492-F8D1-4E1B-A634-79BA906ECE76.html++["驗證是否支援NFS組態。"]


* 完成下列ONTAP 的VMware及vSphere工作。




== 執行任務ONTAP

. link:++https://docs.netapp.com/ontap-9/topic/com.netapp.doc.dot-cm-cmpr-980/system__license__show.html++["驗ONTAP 證NFS的不實授權。"]
+
.. 使用「系統授權show」命令、檢查是否列出NFS。
.. 使用「license add -license code-Code < license code>」來新增授權。


. link:++https://docs.netapp.com/ontap-9/topic/com.netapp.doc.pow-nfs-cg/GUID-6D7A1BB1-C672-46EF-B3DC-08EBFDCE1CD5.html++["遵循NFS組態工作流程。"]




== VMware vSphere工作

link:++https://docs.netapp.com/ontap-9/topic/com.netapp.doc.exp-nfs-vaai/GUID-D78DD9CF-12F2-4C3C-AD3A-002E5D727411.html++["遵循vSphere的NFS用戶端組態工作流程。"]



== 參考資料

vSphere可讓客戶使用企業級NFS陣列、同時存取ESXi叢集中所有節點的資料存放區。如資料存放區一節所述、在使用NFS搭配vSphere時、會有一些易於使用和儲存效率可見度的優點。

搭配ONTAP vSphere使用VMware NFS時、建議採用下列最佳實務做法：

* 在叢集中的每個節點上、為每個SVM使用單一邏輯介面（LIF）ONTAP 。不再需要過去針對每個資料存放區的LIF建議。雖然直接存取（LIF和資料存放區位於同一個節點）是最佳選擇、但請勿擔心間接存取、因為效能影響通常很小（微秒）。
* VMware自VMware Infrastructure 3以來就一直支援NFSv3。vSphere 6.0新增對NFSv4.1的支援、可啟用某些進階功能、例如Kerberos安全性。NFSv3使用用戶端鎖定功能時、NFSv4.1會使用伺服器端鎖定功能。雖然可以透過這兩種傳輸協定匯出一個資料區、但ESXi只能透過一個傳輸協定掛載。ONTAP此單一傳輸協定掛載並不排除其他ESXi主機透過不同版本掛載相同的資料存放區。請務必指定要在掛載時使用的傳輸協定版本、以便所有主機使用相同版本、因此鎖定樣式相同。請勿在主機之間混合使用NFS版本。如有可能、請使用主機設定檔檢查是否符合規定。
+
** 由於NFSv3與NFSv4.1之間沒有自動資料存放區轉換、因此請建立新的NFSv4.1資料存放區、並使用Storage VMotion將VM移轉至新的資料存放區。
** 請參閱中的NFS v4.1互通性表附註 https://mysupport.netapp.com/matrix/["NetApp互通性對照表工具"^] 支援所需的特定ESXi修補程式層級。


* NFS匯出原則用於控制vSphere主機的存取。您可以將一個原則與多個磁碟區（資料存放區）搭配使用。使用NFSv3時、ESXi會使用sys（UNIX）安全樣式、並需要root掛載選項來執行VM。在現階段、此選項稱為超級使用者、使用超級使用者選項時、不需要指定匿名使用者ID。ONTAP請注意、針對「-anon」和「-allow-suid」使用不同值的匯出原則規則、可能會導致SVM探索問題ONTAP 。以下是原則範例：
+
** 存取傳輸協定：nfs3
** 用戶端配對規格：192．168．42．21
** RO存取規則：系統
** RW存取規則：系統
** 匿名UID：
** 超級使用者：sys


* 如果使用適用於VMware VAAI的NetApp NFS外掛程式、則在建立或修改匯出原則規則時、該傳輸協定應設為「NFS」。VAAI複本卸載作業需要NFSv4傳輸協定、而將傳輸協定指定為「NFS」會自動同時包含NFSv3和NFSv3版本。
* NFS資料存放區磁碟區是從SVM的根磁碟區連結而來、因此ESXi也必須能夠存取根磁碟區、才能瀏覽及掛載資料存放區磁碟區。根磁碟區和資料存放區磁碟區連接的任何其他磁碟區的匯出原則、必須包含ESXi伺服器授予其唯讀存取權的規則或規則。以下是根磁碟區的原則範例、也使用VAAI外掛程式：
+
** 存取傳輸協定：NFS（包括nfs3和nfs4）
** 用戶端配對規格192．168．42．21
** RO存取規則。系統
** RW存取規則。Never（root Volume的最佳安全性）
** 匿名UID：
** 超級使用者：sys（也適用於採用VAAI的根Volume）


* 使用ONTAP VMware vSphere的VMware Infrastructure（最重要的最佳實務做法）：
+
** 使用VMware vSphere的VMware VMware VMware vSphere功能來配置資料存放區、因為它能自動簡化匯出原則的管理。ONTAP
** 使用外掛程式為VMware叢集建立資料存放區時、請選取叢集而非單一ESX伺服器。此選項會觸發IT自動將資料存放區掛載至叢集中的所有主機。
** 使用外掛程式掛載功能、將現有的資料存放區套用至新的伺服器。
** 如果不使用ONTAP VMware vSphere的VMware vSphere功能、請針對所有伺服器或需要額外存取控制的每個伺服器叢集、使用單一匯出原則。


* 雖然供應彈性的Volume命名空間結構、可利用交會在樹狀結構中排列磁碟區、但這種方法對vSphere沒有任何價值。ONTAP無論儲存設備的命名空間階層為何、它都會在資料存放區根目錄中為每個VM建立一個目錄。因此、最佳實務做法是將vSphere磁碟區的交會路徑掛載到SVM的根磁碟區、這就是ONTAP VMware vSphere的VMware vSphere功能如何配置資料存放區。沒有巢狀結點路徑也表示除了根磁碟區之外、沒有任何磁碟區相依於任何磁碟區、即使是刻意將磁碟區離線或銷毀、也不會影響其他磁碟區的路徑。
* 對於NFS資料存放區上的NTFS分割區、4K區塊大小是可以的。下圖說明從vSphere主機連線至ONTAP VMware NFS資料存放區的能力。


image:vsphere_ontap_image3.png["錯誤：缺少圖形影像"]

下表列出NFS版本及支援的功能。

|===
| vSphere功能 | NFSv3 | NFSv4.1 


| vMotion與Storage vMotion | 是的 | 是的 


| 高可用度 | 是的 | 是的 


| 容錯能力 | 是的 | 是的 


| DRS | 是的 | 是的 


| 主機設定檔 | 是的 | 是的 


| 儲存DRS | 是的 | 否 


| 儲存I/O控制 | 是的 | 否 


| SRM | 是的 | 否 


| 虛擬磁碟區 | 是的 | 否 


| 硬體加速（VAAI） | 是的 | 是（vSphere 6.5及更新版本、NetApp VAAI外掛程式1.1.2） 


| Kerberos驗證 | 否 | 是（vSphere 6.5及更新版本增強支援AES、krb5i） 


| 多重路徑支援 | 否 | 否（ESXi 6.5及更新版本透過工作階段主幹支援；ONTAP 支援透過pNFS提供支援） 
|===


== 接下來呢？

完成這些工作之後、NFS資料存放區就可以開始耗用資源來配置虛擬機器。
