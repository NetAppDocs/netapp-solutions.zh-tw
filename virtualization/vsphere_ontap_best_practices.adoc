---
sidebar: sidebar 
permalink: virtualization/vsphere_ontap_best_practices.html 
keywords: vSphere, datastore, VMFS, FC, FCoE, NVMe/FC, iSCSI, NFS, vVols 
summary: 本頁說明在ONTAP VMware vSphere環境中實作NetApp解決方案的最佳實務做法。 
---
= 資料存放區與傳輸協定
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./../media/




== vSphere資料存放區與傳輸協定功能

使用七種傳輸協定將VMware vSphere連接至執行ONTAP VMware軟體的系統上的資料存放區：

* FCP
* FCoE
* NVMe / FC
* NVMe / TCP
* iSCSI
* NFS v3
* NFS v4.1


FCP、FCoE、NVMe/FC、NVMe/TCP和iSCSI是區塊傳輸協定、使用vSphere虛擬機器檔案系統（VMFS）將VM儲存在ONTAP 包含ONTAP FlexVol 在一個EesfVolume中的SesfLUN或NVMe命名空間內。請注意、從vSphere 7.0開始、VMware不再支援正式作業環境中的軟體FCoE。NFS是一種檔案傳輸協定、可將VM放入資料存放區（只是ONTAP 指不需要VMFS的功能）。SMB（CIFS）、iSCSI、NVMe / TCP或NFS也可直接從客體作業系統使用到ONTAP 不支援。

下表說明vSphere支援ONTAP 的傳統資料存放區功能及功能。此資訊不適用於vVols資料存放區、但通常適用於使用支援ONTAP 的版本資訊的vSphere 6.x及更新版本。您也可以諮詢 https://www.vmware.com/support/pubs/["VMware組態上限"^] 以確認特定vSphere版本的特定限制。

|===
| 功能/特色 | FC/FCoE | iSCSI | NVMe | NFS 


| 格式 | VMFS或原始裝置對應（RDM） | VMFS或RDM | VMFS | 不適用 


| 資料存放區或LUN的最大數量 | 每個主機有1024個LUN | 每個伺服器有1024個LUN | 每個伺服器256個Namespeces | 256個掛載預設NFS。最大磁碟區為8。使用VMware vSphere的VMware vSphere功能將其提升至256個。ONTAP 


| 最大資料存放區大小 | 64TB | 64TB | 64TB | 100TB FlexVol 以上的穩定區塊（含FlexGroup 不穩定區） 


| 最大資料存放區檔案大小 | 62TB | 62TB | 62TB | 16TB或62TB、搭配ONTAP 啟用大型檔案的RC1RC1及更新版本 


| 每個LUN或檔案系統的最佳佇列深度 | 64 | 64 | 自動協商 | 請參閱中的NFS.MaxQuestue深度 https://docs.netapp.com/us-en/netapp-solutions/virtualization/vsphere_ontap_recommended_esxi_host_and_other_ontap_settings.html["建議的ESXi主機和其他ONTAP 功能設定"^]。 
|===
下表列出支援的VMware儲存相關功能。

|===
| 容量/功能 | FC/FCoE | iSCSI | NVMe | NFS 


| vMotion | 是的 | 是的 | 是的 | 是的 


| Storage VMotion | 是的 | 是的 | 是的 | 是的 


| VMware HA | 是的 | 是的 | 是的 | 是的 


| 儲存分散式資源排程器（SDR） | 是的 | 是的 | 是的 | 是的 


| 啟用資料保護（VADP）的VMware vStorage API備份軟體 | 是的 | 是的 | 是的 | 是的 


| VM內的Microsoft叢集服務（Microsoft Cluster Service、英文）或容錯移轉叢集 | 是的 | 是* | 是* | 不支援 


| 容錯能力 | 是的 | 是的 | 是的 | 是的 


| Site Recovery Manager | 是的 | 是的 | 否* | 僅適用於v3 * 


| 精簡配置的VM（虛擬磁碟） | 是的 | 是的 | 是的 | 是、不使用VAAI時、NFS上的所有VM都預設使用此設定。 


| VMware原生多重路徑 | 是的 | 是的 | 是、使用新的高效能外掛程式（HPP） | 不適用 
|===
下表列出支援ONTAP 的功能不完整的儲存管理功能。

|===
| 功能/特色 | FC/FCoE | iSCSI | NVMe | NFS 


| 重複資料刪除技術 | 節省陣列成本 | 節省陣列成本 | 節省陣列成本 | 資料存放區的節約效益 


| 資源隨需配置 | 資料存放區或RDM | 資料存放區或RDM | 資料存放區 | 資料存放區 


| 調整資料存放區大小 | 僅成長 | 僅成長 | 僅成長 | 擴充、自動擴充及縮減 


| 適用於Windows、Linux應用程式（客體內）的列舉外掛程式SnapCenter | 是的 | 是的 | 否 | 是的 


| 使用ONTAP VMware vSphere的VMware VMware vSphere的支援工具來監控及主機組態 | 是的 | 是的 | 否 | 是的 


| 使用ONTAP VMware vSphere的VMware vSphere的VMware工具進行資源配置 | 是的 | 是的 | 否 | 是的 
|===
下表列出支援的備份功能。

|===
| 功能/特色 | FC/FCoE | iSCSI | NVMe | NFS 


| Snapshot複本ONTAP | 是的 | 是的 | 是的 | 是的 


| SRM支援複寫備份 | 是的 | 是的 | 否* | 僅適用於v3 * 


| Volume SnapMirror | 是的 | 是的 | 是的 | 是的 


| VMDK映像存取 | 啟用VADP的備份軟體 | 啟用VADP的備份軟體 | 啟用VADP的備份軟體 | 啟用VADP的備份軟體、vSphere Client和vSphere Web Client資料存放區瀏覽器 


| VMDK檔案層級存取 | 啟用VADP的備份軟體、僅限Windows | 啟用VADP的備份軟體、僅限Windows | 啟用VADP的備份軟體、僅限Windows | 啟用VADP的備份軟體和協力廠商應用程式 


| NDMP精細度 | 資料存放區 | 資料存放區 | 資料存放區 | 資料存放區或VM 
|===
* NetApp建議將來賓iSCSI用於Microsoft叢集、而非在VMFS資料存放區中使用支援多寫入器的VMDK。Microsoft和VMware完全支援這種方法、ONTAP 提供優異的靈活度搭配使用VMware（SnapMirror至ONTAP 內部部署或雲端的等化系統）、易於設定和自動化、SnapCenter 並可透過VMware加以保護。vSphere 7新增叢集式VMDK選項。這與啟用多寫入器的VMDK不同、因為VMDK需要透過FC傳輸協定呈現資料存放區、而且此傳輸協定已啟用叢集式VMDK支援。其他限制也適用。請參閱VMware的 https://docs.vmware.com/en/VMware-vSphere/7.0/vsphere-esxi-vcenter-server-70-setup-wsfc.pdf["Windows Server容錯移轉叢集的設定"^] 組態準則文件。

*使用NVMe與NFS v4.1的資料存放區需要vSphere複寫。SRM不支援陣列型複寫。



== 選擇儲存傳輸協定

執行ONTAP 支援所有主要儲存傳輸協定的系統、因此客戶可以根據現有和規劃的網路基礎架構和員工技能、選擇最適合自己環境的系統。NetApp測試通常顯示以類似線路速度執行的傳輸協定之間沒有什麼差異、因此最好將重點放在網路基礎架構和員工能力上、而不只是原始傳輸協定效能。

下列因素可能有助於考量選擇傳輸協定：

* *目前的客戶環境。*雖然IT團隊通常擅長管理乙太網路IP基礎架構、但並非所有人都擅長管理FC SAN架構。不過、使用非專為儲存流量設計的通用IP網路可能無法正常運作。請考量您所擁有的網路基礎架構、任何計畫性的改善、以及員工管理這些基礎架構的技能和可用度。
* *易於設定。*除了FC架構的初始組態設定（額外的交換器和纜線、分區、以及HBA和韌體的互通性驗證）之外、區塊傳輸協定也需要建立及對應LUN、以及由客體作業系統探索及格式化。NFS磁碟區建立及匯出之後、便會由ESXi主機掛載並準備好使用。NFS沒有特殊的硬體限制或韌體可管理。
* *易於管理。*有了SAN傳輸協定、如果需要更多空間、就必須採取幾個步驟、包括擴充LUN、重新掃描以探索新的大小、然後擴充檔案系統）。雖然可以擴充LUN、但減少LUN的大小並不可行、而且恢復未使用的空間可能需要額外的心力。NFS可輕鬆調整規模或縮減規模、儲存系統也能自動調整大小。SAN透過客體作業系統修剪/取消對應命令提供空間回收、讓刪除檔案的空間可以傳回陣列。NFS資料存放區的這類空間回收較為困難。
* *儲存空間的透明度。*在NFS環境中、儲存使用率通常比較容易查看、因為精簡配置可立即回收節約效益。同樣地、相同資料存放區中的其他VM或其他儲存系統磁碟區也可立即使用重複資料刪除和複製的節約效益。NFS資料存放區的VM密度通常也較高、可減少資料存放區的管理數量、進而改善重複資料刪除的節約效益、並降低管理成本。




== 資料存放區配置

可靈活建立VM和虛擬磁碟的資料存放區。ONTAP雖然ONTAP 使用VSC來配置vSphere的資料存放區時會套用許多功能不實的最佳實務做法（請參閱一節 link:vsphere_ontap_recommended_esxi_host_and_other_ontap_settings.html["建議的ESXi主機和其他ONTAP 功能設定"]）、以下是一些額外的考量準則：

* 部署vSphere搭配ONTAP 使用不間斷的NFS資料存放區、可實現高效能且易於管理的實作、提供VM對資料存放區的比率、而這些比率無法透過區塊型儲存傳輸協定取得。此架構可減少相關資料存放區數量、使資料存放區密度增加十倍。雖然較大的資料存放區可提升儲存效率並提供營運效益、但請考慮使用至少四個資料存放區FlexVol （VMware Volume）、將VM儲存在單ONTAP 一的VMware控制器上、以從硬體資源中獲得最大效能。此方法也可讓您建立具有不同恢復原則的資料存放區。根據業務需求、部分備份或複寫的頻率可能會比其他更高。由於資料存放區FlexGroup 是依設計進行擴充、因此不需要使用多個資料存放區來提升效能。
* NetApp建議使用FlexVol Suse Volume、並從ONTAP 功能性的9.8 FlexGroup 功能開始、使用NFS資料存放區。一般不建議使用ONTAP 其他的VMware儲存容器、例如qtree、因為ONTAP VMware vSphere的VMware Tools目前不支援這些儲存容器。將資料存放區部署為單一磁碟區中的多個qtree、對於高度自動化的環境而言、可能很有幫助、因為這些環境可從資料存放區層級配額或VM檔案複製中獲益。
* 適用於不只FlexVol 4TB、更能滿足8TB的需求。這種規模對於效能、管理簡易性和資料保護來說、是一個很好的平衡點。從小規模開始（例如4TB）、視需要擴充資料存放區（最高100TB）。較小的資料存放區可更快從備份或災難後恢復、並可在叢集之間快速移動。請考慮使用ONTAP 不同步自動調整大小、以便在使用空間變更時自動擴充及縮小磁碟區。VMware vSphere資料存放區資源配置精靈的「VMware vSphere資料存放區資源配置精靈」預設會針對新的資料存放區使用自動調整大小。ONTAP您可以使用System Manager或命令列、進一步自訂「成長」和「縮減」臨界值、以及最大和最小大小。
* 此外、VMFS資料存放區也可以設定LUN、以供FC、iSCSI或FCoE存取。VMFS可讓叢集中的每個ESX伺服器同時存取傳統LUN。VMFS資料存放區的大小最多可達64TB、最多可包含32個2TB LUN（VMFS 3）或單一64TB LUN（VMFS 5）。大部分系統的LUN大小僅為16TB、ONTAP All SAN陣列系統的LUN大小上限為12TB。因此、在ONTAP 大多數的不實系統上、可使用四個16TB LUN來建立最大大小的VMFS 5資料存放區。雖然多個LUN的高I/O工作負載（使用高階FAS 的功能或AFF 功能性系統）可獲得效能優勢、但由於建立、管理及保護資料存放區LUN的管理複雜度增加、以及提高可用度風險、因此這項優勢已被抵銷。NetApp一般建議針對每個資料存放區使用單一大型LUN、而且只有在需要超越16TB資料存放區的情況下才需要跨距。與NFS一樣、請考慮使用多個資料存放區（Volume）、在單ONTAP 一的VMware控制器上發揮最大效能。
* 老舊的客體作業系統（OS）需要與儲存系統一致、才能獲得最佳效能和儲存效率。然而、Microsoft和Linux經銷商（例如Red Hat）所支援的現代化作業系統不再需要調整、以使檔案系統分割區與虛擬環境中基礎儲存系統的區塊保持一致。如果您使用的是可能需要調整的舊作業系統、請在NetApp支援知識庫中搜尋文章、使用「VM對齊」、或向NetApp銷售或合作夥伴聯絡人索取TR-3747的複本。
* 避免在客體作業系統中使用重組公用程式、因為這不會帶來效能效益、也不會影響儲存效率和Snapshot複本空間使用量。也請考慮在客體作業系統中關閉虛擬桌面的搜尋索引。
* 以創新的儲存效率功能引領業界、讓您充分發揮可用磁碟空間的效益。ONTAP利用預設的即時重複資料刪除與壓縮技術、支援更高的效率。AFF資料會在集合體中的所有磁碟區中進行重複資料刪除、因此您不再需要將類似的作業系統和類似的應用程式群組在單一資料存放區中、以達到最大的節約效益。
* 在某些情況下、您甚至不需要資料存放區。為獲得最佳效能與管理能力、請避免將資料存放區用於高I/O應用程式、例如資料庫和某些應用程式。相反地、請考慮使用來賓擁有的檔案系統、例如NFS或iSCSI檔案系統、由來賓或RDM管理。如需特定的應用程式指南、請參閱適用於您應用程式的NetApp技術報告。例如、 http://www.netapp.com/us/media/tr-3633.pdf["TR-3633：Data ONTAP Oracle資料庫on"^] 提供虛擬化的相關章節、並提供實用的詳細資料。
* 一流磁碟（或改良的虛擬磁碟）可讓vCenter管理的磁碟獨立於vSphere 6.5及更新版本的VM。雖然主要是由API管理、但在vVols上也很實用、尤其是由OpenStack或Kubernetes工具管理時。支援的項目包括ONTAP VMware ONTAP vSphere的VMware vSphere的支援功能和VMware vSphere的支援功能。




== 資料存放區與VM移轉

將VM從另一個儲存系統上的現有資料存放區移轉至ONTAP 支援區時、請謹記以下幾項實務做法：

* 使用Storage VMotion將大部分虛擬機器移至ONTAP VMware。這種方法不僅不中斷虛ONTAP 擬機器的執行、還能讓諸如即時重複資料刪除和壓縮等儲存效率功能、在資料移轉時處理資料。請考慮使用vCenter功能從清單清單清單中選取多個VM、然後在適當的時間排程移轉（按一下「Actions」（動作）時使用Ctrl鍵）。
* 雖然您可以仔細規劃移轉至適當的目的地資料存放區、但通常較容易大量移轉、然後視需要組織。如果您有特定的資料保護需求、例如不同的Snapshot排程、您可能會想要使用此方法來引導移轉至不同的資料存放區。
* 大多數VM及其儲存設備可能會在執行（Hot）時移轉、但從其他儲存系統移轉附加（非資料存放區）儲存設備（例如ISO、LUN或NFS磁碟區）可能需要冷移轉。
* 需要更謹慎移轉的虛擬機器包括使用附加儲存設備的資料庫和應用程式。一般而言、請考慮使用應用程式的工具來管理移轉作業。對於Oracle、請考慮使用Oracle工具（例如RMAN或ASM）來移轉資料庫檔案。請參閱 https://www.netapp.com/us/media/tr-4534.pdf["TR-4534"^] 以取得更多資訊。同樣地、對於SQL Server、請考慮使用SQL Server Management Studio或NetApp工具、例如SnapManager 適用於SQL Server或SnapCenter VMware。




== VMware vSphere適用的工具ONTAP

搭配執行ONTAP VMware vCenter軟體的系統使用vSphere時、最重要的最佳實務做法是安裝及使用ONTAP VMware vSphere外掛程式（前身為虛擬儲存主控台）的VMware VMware vSphere資訊工具。無論使用SAN或NAS、此vCenter外掛程式都能簡化儲存管理、提升可用度、並降低儲存成本和營運成本。它採用最佳實務做法來配置資料存放區、並針對多重路徑和HBA逾時最佳化ESXi主機設定（如附錄B所述）。因為它是vCenter外掛程式、所以可用於連線至vCenter伺服器的所有vSphere Web用戶端。

外掛程式也能協助您在ONTAP vSphere環境中使用其他的功能。它可讓您安裝適用於VMware VAAI的NFS外掛程式、以便將複本卸載至ONTAP VMware、以便進行VM複製作業、保留空間以供複本虛擬磁碟檔案使用、ONTAP 以及執行「Snapshot複本卸載」。

外掛程式也是VASA Provider許多功能的管理介面、ONTAP 可支援vVols的儲存原則型管理。在登錄VMware vSphere的VMware vSphere基礎架構工具之後ONTAP 、請使用它來建立儲存功能設定檔、將其對應至儲存設備、並確保資料存放區在一段時間內符合設定檔的要求。VASA Provider也提供一個介面、可用來建立及管理VVol資料存放區。

一般而言、NetApp建議在ONTAP vCenter內使用VMware vSphere的VMware vCenter功能的VMware vCenter功能、來配置傳統和vVols資料存放區、以確保遵循最佳實務做法。



== 一般網路

使用vSphere搭配執行ONTAP VMware軟體的系統時、設定網路設定很簡單、而且類似於其他網路組態。以下是幾點需要考量的事項：

* 將儲存網路流量與其他網路區隔。使用專屬的VLAN或獨立的交換器來儲存、即可建立獨立的網路。如果儲存網路共用實體路徑（例如上行鏈路）、您可能需要QoS或額外的上行鏈路連接埠、以確保有足夠的頻寬。請勿將主機直接連接至儲存設備；請使用交換器建立備援路徑、讓VMware HA在不需介入的情況下運作。
* 如果您的網路需要並支援巨型框架、尤其是使用iSCSI時、可以使用巨型框架。如果使用、請確定在儲存設備和ESXi主機之間的路徑中、所有網路裝置、VLAN等上的設定都相同。否則、您可能會看到效能或連線問題。MTU也必須在ESXi虛擬交換器、VMkernel連接埠、以及每ONTAP 個節點的實體連接埠或介面群組上設定相同。
* NetApp僅建議停用ONTAP 叢集內叢集網路連接埠上的網路流量控制。對於用於資料流量的其餘網路連接埠、NetApp並未提出其他最佳實務做法建議。您應視需要啟用或停用。請參閱 http://www.netapp.com/us/media/tr-4182.pdf["TR-4182"^] 以取得流程控制的更多背景資訊。
* 當ESXi和ONTAP VMware ESXi儲存陣列連接至乙太網路儲存網路時、NetApp建議將這些系統連接的乙太網路連接埠設定為快速擴充樹狀傳輸協定（RSTP）邊緣連接埠、或使用Cisco PortFast功能。NetApp建議在使用Cisco PortFast功能的環境中、啟用跨距樹狀結構PortFast主幹功能、並在ESXi伺服器或ONTAP VMware®儲存陣列上啟用802.1Q VLAN主幹連線。
* NetApp建議下列連結集合最佳實務做法：
+
** 使用支援連結集合連接兩個獨立交換器機箱上連接埠的交換器、使用多機箱連結集合群組方法、例如Cisco的虛擬PortChannel（vPC）。
** 除非您使用已設定LACP的DVSwitches 5.1或更新版本、否則請停用連接至ESXi的交換器連接埠LACP。
** 使用LACP建立鏈路集合體、以動態ONTAP 多重模式介面群組搭配IP雜湊、以利支援靜態儲存系統。
** 在ESXi上使用IP雜湊群組原則。




下表提供網路組態項目的摘要、並指出套用設定的位置。

|===
| 項目 | ESXi | 交換器 | 節點 | SVM 


| IP 位址 | VMkernel | 否* | 否* | 是的 


| 連結集合體 | 虛擬交換器 | 是的 | 是的 | 否* 


| VLAN | VMkernel和VM連接埠群組 | 是的 | 是的 | 否* 


| 流程控制 | NIC | 是的 | 是的 | 否* 


| 跨距樹狀結構 | 否 | 是的 | 否 | 否 


| MTU（用於巨型框架） | 虛擬交換器與VMkernel連接埠（9000） | 是（設為上限） | 有（9000） | 否* 


| 容錯移轉群組 | 否 | 否 | 是（建立） | 是（選取） 
|===
* SVM lifs連接到具有VLAN、MTU及其他設定的連接埠、介面群組或VLAN介面。不過、這些設定不會在SVM層級進行管理。

這些裝置擁有自己的IP位址進行管理、但這些位址並未用於ESXi儲存網路環境。



== SAN（FC、FCoE、NVMe/FC、iSCSI）、RDM

在vSphere中、有三種使用區塊儲存LUN的方法：

* 使用VMFS資料存放區
* 使用原始裝置對應（RDM）
* 由軟體啟動器從VM客體作業系統存取及控制的LUN


VMFS是高效能的叢集式檔案系統、可提供共用儲存資源池的資料存放區。VMFS資料存放區可設定LUN、使用NVMe / FC傳輸協定存取的FC、iSCSI、FCoE或NVMe命名空間來存取。VMFS可讓叢集中的每個ESX伺服器同時存取傳統LUN。支援的最大LUN大小通常為16TB；因此、使用四個16TB LUN（所有SAN陣列系統支援的最大VMFS LUN大小為64TB）、即可建立最大大小為64TB的VMFS 5資料存放區（請參閱本節的第一個表格）ONTAP 。由於VMware不具備小型的個別佇列深度、所以在VMware中、VMFS資料存放區的擴充程度比傳統陣列架構的擴充程度更高、而且相對簡單。ONTAP ONTAP

vSphere內建多個儲存裝置路徑的支援功能、稱為原生多重路徑（NMP）。NMP可偵測支援儲存系統的儲存類型、並自動設定NMP堆疊以支援使用中儲存系統的功能。

NMP和NetApp ONTAP 的支援非對稱邏輯單元存取（ALUA）、可協調最佳化和非最佳化的路徑。在本功能中、ALUA最佳化路徑會使用主控所存取LUN的節點上的目標連接埠、遵循直接資料路徑。ONTAP預設會在vSphere和ONTAP VMware中同時開啟ALUA。NMP將ONTAP 該叢集辨識為ALUA、並使用ALUA儲存陣列類型外掛程式（'VMW_SATP_ALUA'）、然後選取循環配置資源路徑選擇外掛程式（'VMW_PSP_RR'）。

ESXi 6最多可支援256個LUN、並可支援多達1、024條通往LUN的總路徑。ESXi不會看到任何超出這些限制的LUN或路徑。假設LUN數量上限、則路徑限制允許每個LUN有四個路徑。在更大ONTAP 的實體叢集中、可以在LUN限制之前達到路徑限制。為了解決此限制、ONTAP 支援8.3版及更新版本中的選擇性LUN對應（SLM),

對於向指定LUN通告路徑的節點、SLM會有限制。NetApp最佳實務做法是每個SVM每個節點至少有一個LIF、並使用SLM來限制通告給裝載LUN及其HA合作夥伴之節點的路徑。雖然有其他路徑存在，但預設不會通告這些路徑。您可以使用新增和移除在SLMs中的報告節點引數來修改通告的路徑。請注意、在8.3之前的版本中建立的LUN會通告所有路徑、而且必須加以修改、才能只向主機HA配對通告路徑。如需更多關於SLM,請參閱第5.9節 http://www.netapp.com/us/media/tr-4080.pdf["TR-4080"^]。先前的連接埠集方法也可用於進一步減少LUN的可用路徑。PortSets可減少igroup中的啟動器可透過哪些可見路徑來查看LUN、進而提供協助。

* 根據預設、會啟用SLM.除非您使用連接埠集、否則不需要額外的組態。
* 對於Data ONTAP 在更新版本不含更新版本8.3之前建立的LUN、請執行「LUN對應移除報告節點」命令、手動套用SLM、以移除LUN報告節點、並將LUN存取限制在LUN所屬節點及其HA合作夥伴。


區塊傳輸協定（iSCSI、FC和FCoE）使用LUN ID和序號以及唯一名稱來存取LUN。FC和FCoE使用全球名稱（WWNN和WWPN）、iSCSI則使用iSCSI合格名稱（IQN）。儲存設備內部的LUN路徑對區塊傳輸協定毫無意義、而且不會出現在傳輸協定的任何位置。因此、只包含LUN的磁碟區根本不需要內部掛載、而包含資料存放區所用LUN的磁碟區則不需要使用交會路徑。NVMe子系統ONTAP 的運作方式類似。

其他應考慮的最佳實務做法：

* 請確定ONTAP 已為叢集中每個節點上的每個SVM建立邏輯介面（LIF）、以達到最大可用度和行動性。最佳實務做法是每個節點使用兩個實體連接埠和LIF、每個光纖使用一個連接埠。ONTAPALUA可用來剖析路徑、識別作用中最佳化（直接）路徑、以及作用中未最佳化路徑。ALUA用於FC、FCoE和iSCSI。
* 對於iSCSI網路、當存在多個虛擬交換器時、請在不同的網路子網路上使用多個VMkernel網路介面搭配NIC群組。您也可以使用多個實體NIC來連接至多個實體交換器、以提供HA並提高處理量。下圖提供多重路徑連線的範例。在靜態中ONTAP 、設定單一模式介面群組以容錯移轉兩個或多個連結連接至兩個或多個交換器、或使用LACP或其他連結集合技術搭配多重模式介面群組、以提供HA及連結集合的優點。
* 如果在ESXi中使用挑戰握手驗證傳輸協定（CHAP）進行目標驗證、則必須ONTAP 使用CLI（「vserver iSCSI安全性建立」）或System Manager（在「Storage」（儲存）>「SVM」（SVM）>「SVM設定」（SVM設定）>「Protocol」（傳輸協定）>「iSCSI」（iSCSI）下編輯啟動器安全性）。
* 使用VMware vSphere的VMware vCenter工具來建立及管理LUN和群組。ONTAP外掛程式會自動決定伺服器的WWPN、並建立適當的igroup。它也會根據最佳實務做法來設定LUN、並將其對應至正確的igroup。
* 請謹慎使用RDM、因為它們可能較難管理、而且也會使用路徑、但這一點如前所述有所限制。支援這兩種LUN ONTAP https://kb.vmware.com/s/article/2009226["實體與虛擬相容模式"^] RDM。
* 如需更多關於將NVMe/FC搭配vSphere 7.0使用的資訊、請參閱此 https://docs.netapp.com/us-en/ontap-sanhost/nvme_esxi_7.html["NVMe / FC主機組態指南ONTAP"^] 和 http://www.netapp.com/us/media/tr-4684.pdf["TR-4684"^]下圖說明從vSphere主機到ONTAP VMware LUN的多重路徑連線能力。


image:vsphere_ontap_image2.png["錯誤：缺少圖形影像"]



== NFS

vSphere可讓客戶使用企業級NFS陣列、同時存取ESXi叢集中所有節點的資料存放區。如資料存放區一節所述、在使用NFS搭配vSphere時、會有一些易於使用和儲存效率可見度的優點。

搭配ONTAP vSphere使用VMware NFS時、建議採用下列最佳實務做法：

* 在叢集中的每個節點上、為每個SVM使用單一邏輯介面（LIF）ONTAP 。不再需要過去針對每個資料存放區的LIF建議。雖然直接存取（LIF和資料存放區位於同一個節點）是最佳選擇、但請勿擔心間接存取、因為效能影響通常很小（微秒）。
* VMware自VMware Infrastructure 3以來就一直支援NFSv3。vSphere 6.0新增對NFSv4.1的支援、可啟用某些進階功能、例如Kerberos安全性。NFSv3使用用戶端鎖定功能時、NFSv4.1會使用伺服器端鎖定功能。雖然可以透過這兩種傳輸協定匯出一個資料區、但ESXi只能透過一個傳輸協定掛載。ONTAP此單一傳輸協定掛載並不排除其他ESXi主機透過不同版本掛載相同的資料存放區。請務必指定要在掛載時使用的傳輸協定版本、以便所有主機使用相同版本、因此鎖定樣式相同。請勿在主機之間混合使用NFS版本。如有可能、請使用主機設定檔檢查是否符合規定。
+
** 由於NFSv3與NFSv4.1之間沒有自動資料存放區轉換、因此請建立新的NFSv4.1資料存放區、並使用Storage VMotion將VM移轉至新的資料存放區。
** 請參閱中的NFS v4.1互通性表附註 https://mysupport.netapp.com/matrix/["NetApp互通性對照表工具"^] 支援所需的特定ESXi修補程式層級。


* NFS匯出原則用於控制vSphere主機的存取。您可以將一個原則與多個磁碟區（資料存放區）搭配使用。使用NFSv3時、ESXi會使用sys（UNIX）安全樣式、並需要root掛載選項來執行VM。在現階段、此選項稱為超級使用者、使用超級使用者選項時、不需要指定匿名使用者ID。ONTAP請注意、匯出具有不同值的原則規則 `-anon` 和 `-allow-suid` 可能會導致SVM發現ONTAP 問題、因為使用這些功能。以下是原則範例：
+
** 存取傳輸協定：nfs3
** 用戶端配對規格：192．168．42．21
** RO存取規則：系統
** RW存取規則：系統
** 匿名UID
** 超級使用者：sys


* 如果使用適用於VMware VAAI的NetApp NFS外掛程式、則在建立或修改匯出原則規則時、該傳輸協定應設為「NFS」。VAAI複本卸載作業需要NFSv4傳輸協定、而將傳輸協定指定為「NFS」會自動同時包含NFSv3和NFSv3版本。
* NFS資料存放區磁碟區是從SVM的根磁碟區連結而來、因此ESXi也必須能夠存取根磁碟區、才能瀏覽及掛載資料存放區磁碟區。根磁碟區和資料存放區磁碟區連接的任何其他磁碟區的匯出原則、必須包含ESXi伺服器授予其唯讀存取權的規則或規則。以下是根磁碟區的原則範例、也使用VAAI外掛程式：
+
** 存取傳輸協定：NFS（包括nfs3和nfs4）
** 用戶端配對規格：192．168．42．21
** RO存取規則：系統
** RW存取規則：Never（root Volume的最佳安全性）
** 匿名UID
** 超級使用者：sys（也適用於採用VAAI的根Volume）


* 使用ONTAP VMware vSphere的VMware Infrastructure（最重要的最佳實務做法）：
+
** 使用VMware vSphere的VMware VMware VMware vSphere功能來配置資料存放區、因為它能自動簡化匯出原則的管理。ONTAP
** 使用外掛程式為VMware叢集建立資料存放區時、請選取叢集而非單一ESX伺服器。此選項會觸發IT自動將資料存放區掛載至叢集中的所有主機。
** 使用外掛程式掛載功能、將現有的資料存放區套用至新的伺服器。
** 如果不使用ONTAP VMware vSphere的VMware vSphere功能、請針對所有伺服器或需要額外存取控制的每個伺服器叢集、使用單一匯出原則。


* 雖然供應彈性的Volume命名空間結構、可利用交會在樹狀結構中排列磁碟區、但這種方法對vSphere沒有任何價值。ONTAP無論儲存設備的命名空間階層為何、它都會在資料存放區根目錄中為每個VM建立一個目錄。因此、最佳實務做法是將vSphere磁碟區的交會路徑掛載到SVM的根磁碟區、這就是ONTAP VMware vSphere的VMware vSphere功能如何配置資料存放區。沒有巢狀結點路徑也表示除了根磁碟區之外、沒有任何磁碟區相依於任何磁碟區、即使是刻意將磁碟區離線或銷毀、也不會影響其他磁碟區的路徑。
* 對於NFS資料存放區上的NTFS分割區、4K區塊大小是可以的。下圖說明從vSphere主機連線至ONTAP VMware NFS資料存放區的能力。


image:vsphere_ontap_image3.png["錯誤：缺少圖形影像"]

下表列出NFS版本及支援的功能。

|===
| vSphere功能 | NFSv3 | NFSv4.1 


| vMotion與Storage vMotion | 是的 | 是的 


| 高可用度 | 是的 | 是的 


| 容錯能力 | 是的 | 是的 


| DRS | 是的 | 是的 


| 主機設定檔 | 是的 | 是的 


| 儲存DRS | 是的 | 否 


| 儲存I/O控制 | 是的 | 否 


| SRM | 是的 | 否 


| 虛擬磁碟區 | 是的 | 否 


| 硬體加速（VAAI） | 是的 | 是的 


| Kerberos驗證 | 否 | 是（vSphere 6.5及更新版本增強支援AES、krb5i） 


| 多重路徑支援 | 否 | ESXi 7.0U3f及更新版本支援ONTAP 使用VMware更新版本的作業階段主幹連線 
|===


== FlexGroup

支援vSphere中的VMware vSphere資料存放區、以及VMware vSphere 9.8版的VMware vCenter工具。ONTAP FlexGroup ONTAP此功能可簡化大型資料存放區的建立作業、並自動建立多個組成磁碟區、以發揮整個系統的最大效能。FlexGroup ONTAP利用vSphere的功能將VMware支援功能用於單一、可擴充的vSphere資料存放區、並具備完整的VMware叢集功能。FlexGroup ONTAP

除了針對vSphere工作負載進行廣泛的系統測試之外、ONTAP 還為FlexGroup VMware資料存放區新增了複本卸載機制。這會使用改良的複製引擎、在背景中的成員之間複製檔案、同時允許存取來源和目的地。根據規模、當需要時、多個複本會使用可立即使用且節省空間的檔案複本。

此外、針對VMware vSphere儀表板和VM報告、還新增檔案型效能指標（IOPS、處理量和延遲）、這些指標可在VMware vSphere儀表板和VM報告的「參考」工具中檢視。ONTAP FlexGroup ONTAPVMware vSphere外掛程式的支援功能也可讓您使用最大和/或最小IOPS的組合來設定服務品質（QoS）規則。ONTAP這些設定可以跨資料存放區中的所有VM進行設定、也可以針對特定VM個別設定。

以下是NetApp開發的其他一些最佳實務做法：

* 使用FlexGroup 預設的資源配置。建議使用VMware vSphere的VMware vSphere功能、因為它能在vSphere中建立及掛載功能、但可能會使用VMware System Manager或命令列來滿足特殊需求。ONTAP FlexGroup ONTAP即使如此、仍會使用預設值、例如每個節點的組成成員數目、因為這是vSphere測試過的項目。
* 調整FlexGroup VMware資料存放區規模時、請記住FlexGroup 、此功能包含FlexVol 多個較小的、可建立較大命名空間的支援區。因此、請將資料存放區的大小調整為最大虛擬機器的8倍以上。例如、如果您的環境中有6TB的VM、FlexGroup 請將該資料存放區的大小調整至不小於48TB。
* 允許FlexGroup 執行功能以管理資料存放區空間。vSphere資料存放區已測試過自動調整規模與彈性調整。如果資料存放區接近完整容量、請使用ONTAP VMware vSphere的VMware vCenter功能或其他工具來調整FlexGroup VMware Volume的大小。如果容量允許、則可將資料夾（VM）內的檔案優先順序設定為相同的組成要素、藉此平衡各成員的容量和inode。FlexGroup
* VMware與NetApp目前不支援通用的多重路徑網路方法。對於NFSv4.1、NetApp支援pNFS、而VMware則支援工作階段主幹連線。NFSv3不支援多個實體路徑通往磁碟區。針對使用VMware vSphere的VMware 9.8、我們建議的最佳實務做法是讓VMware vSphere的VMware vSphere使用VMware vSphere的VMware Tools進行單一掛載、因為間接存取的影響通常很小（微秒）FlexGroup ONTAP ONTAP 。您可以使用循環DNS、將ESXi主機分散到FlexGroup 不同節點上的各個LIF上、但這需要FlexGroup 建立及掛載不ONTAP 含VMware vSphere的任何VMware vSphere用的VMware vCenter工具的功能。因此效能管理功能將無法使用。
* vSphere資料存放區支援已在9.8版中測試高達1500部VM。FlexGroup
* 使用適用於VMware VAAI的NFS外掛程式進行複本卸載。請注意FlexGroup 、ONTAP 雖然在VMware資料存放區內強化複製功能、但在FlexVol 將VM複製到VMware和/或FlexGroup VMware磁碟區之間時、與ESXi主機複本相比、VMware不提供顯著的效能優勢。
* 使用VMware vSphere 9.8的支援功能、使用VMware vSphere 9.8的支援指標（儀表板和VM報告）來監控各個VM的效能、以及管理個別VM上的QoS。ONTAP FlexGroup ONTAP目前無法透過ONTAP REST指令或API取得這些指標。
* QoS（最大/最小IOPS）可在個別VM或資料存放區中的所有VM上設定。在所有VM上設定QoS會取代任何個別VM設定。設定未來不會延伸至新的或移轉的VM；您可以在新的VM上設定QoS、或是將QoS重新套用至資料存放區中的所有VM。
* VMware vSphere 4.4版的支援VMware vSphere的子外掛程式、可在主儲存系統的VMware資料存放區中備份及還原VM。SnapCenter FlexGroup雖然SnapMirror可手動用於將FlexGroup 某個不間斷資料複製到二線系統、但4號選擇控制閥並不會管理二線複本。

